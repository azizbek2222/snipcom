<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>HTML Run App - Multi File Unlimited</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>
<style>
*{box-sizing:border-box;font-family:Segoe UI,sans-serif}
/* O'ZGARTIRILDI: run sahifasida hech qanday orqa fon va bo'sh joy qolmasligi uchun */
body{
  margin:0;
  padding:0;
  min-height:100vh;
  /* Qolgan CSS stillari (fon rang, gradient) o'chirildi */
  color:#000; /* Matn rangi, agar kod o'z matn rangini belgilamasa */
}
/* EDITOR */
.app{
  max-width:700px;
  margin:auto;
  padding:25px;
  /* Editorning o'z fonini saqlab qolish uchun qo'shimcha stil, faqat editor ko'rinib turganda ishlaydi */
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); 
  color:#fff;
}
input, textarea{
  width:100%;
  border-radius:12px;
  border:none;
  padding:15px;
  margin-bottom:10px;
}
textarea{
  height:160px;
}
button{
  width:100%;
  margin-top:5px;
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  background:linear-gradient(135deg,#00f260,#0575e6);
  color:#fff;
}
/* RUN PAGE */
/* O'ZGARTIRILDI: Linkka kirilganda hech qanday padding (bo'sh joy) qolmasligi uchun */
#runResult{
  padding:0; 
  width: 100%;
  height: 100vh;
}
</style>
</head>
<body>

<div id="editor" class="app">
  <h2>ðŸš€ HTML Run App - Cheksiz Fayl</h2>
  <input type="text" id="name" placeholder="Link nomini yozing (masalan: loyiham-mening)">
  <textarea id="code" placeholder="HTML kod yoki index.html yozing..."></textarea>
  <input type="file" id="files" multiple webkitdirectory directory>
  <button onclick="save()">â–¶ RUN & LINK</button>
  <p id="link"></p>
</div>

<div id="runResult" style="display:none"></div>

<script>
var firebaseConfig={
  apiKey:"AIzaSyBrMKJ4MPilQg6gZsaE-Hlqlgo5F4Q8IsM",
  databaseURL:"https://xabar-tizimi-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.database();

// URLdan run parameterni olish
var params=new URLSearchParams(location.search);
var runId=params.get("run");

if(runId){
  // Linkga kirilganda tana (body) stillarini butunlay o'chirish
  document.body.style.background = 'none';
  document.body.style.color = 'inherit';
  document.body.style.minHeight = '0';
  document.body.style.overflow = 'hidden'; // O'ram qismini olib tashlash

  document.getElementById("editor").style.display="none";
  document.getElementById("runResult").style.display="block";

  db.ref("codes/"+runId).once("value").then(snap=>{
    var files = snap.val(); // Object: {filename: code}
    var mainFileCode = null;
    
    // index kalitini qidirish (agar u barcha fayllar ichida bo'lsa)
    if (files.index) {
        mainFileCode = files.index;
    } else {
        // Agar index topilmasa, birinchi faylni olish
        for(var fname in files){
            mainFileCode = files[fname];
            break; // Faqat birinchi faylni olib, tugatish
        }
    }

    if (mainFileCode) {
        var iframe = document.createElement("iframe");
        iframe.style.width="100%";
        // O'ZGARTIRILDI: Kichik oyna emas, butun ekranni egallashi uchun
        iframe.style.height="100vh"; 
        iframe.style.border="none"; // Chegarani olib tashlash
        // Faqat topilgan asosiy fayl iframe ichida ochiladi
        iframe.srcdoc = mainFileCode;
        document.getElementById("runResult").appendChild(iframe);
        
        // Iframe'ning joylashuvi butun ekranga moslashishi uchun
        document.getElementById("runResult").style.position = 'fixed';
        document.getElementById("runResult").style.top = '0';
        document.getElementById("runResult").style.left = '0';
    }
  });
}

function save(){
  var name = document.getElementById("name").value.trim();
  if(!name){
    alert("Iltimos link uchun nom yozing!");
    return;
  }

  var files = document.getElementById("files").files;
  var fileCodes = {}; // Barcha fayllarni saqlash uchun object

  if(files.length === 0){
    var codeArea = document.getElementById("code").value;
    // Fayl tanlanmagan bo'lsa, 'index' nomi ostida saqlanadi
    fileCodes["index"] = codeArea; 
    saveToFirebase(name, fileCodes);
  } else {
    let readCount = 0;
    for(let i=0;i<files.length;i++){
      let file = files[i];
      let reader = new FileReader();
      reader.onload = function(e){
        // Fayl nomini olamiz (index.html -> index, style.css -> style)
        let fname = file.name.replace(/\.[^/.]+$/,""); 
        fileCodes[fname] = e.target.result;
        readCount++;
        if(readCount === files.length){
          saveToFirebase(name, fileCodes);
        }
      }
      reader.readAsText(file);
    }
  }
}

function saveToFirebase(name, filesObj){
  var randomStr = Math.random().toString(36).substring(2,8);
  var uniqueId = name + "-" + randomStr;

  db.ref("codes/"+uniqueId).set(filesObj);

  var link = location.origin + location.pathname + "?run=" + encodeURIComponent(uniqueId);
  document.getElementById("link").innerHTML = `<a href="${link}" target="_blank">${link}</a>`;
}
</script>

</body>
</html>
